                            ;________________________________________
                            ;
                            ;  MUSIC PLAYER AND MUSIC FROM
                            ;  FORBIDDEN FOREST BY PAUL NORMAN.
                            ;
                            ;  SYS4102 TO START
                            ;________________________________________

				.ORG $1000

				JMP INIT
				JMP PLAY
				JMP PLAYSONG

PLAYSONG
        JSR INIT
        JSR SETUP_IRQ
        RTS

SETUP_IRQ
	      SEI
	      LDA #<IRQ
	      STA $0314
	      LDA #>IRQ
	      STA $0315
	      LDA #248
	      STA $D012           ; Stop at the lower border
	      LDA $D011
	      AND #%01111111
	      STA $D011
	      LDA #%10000001
	      STA $D01A
	      CLI
	      RTS

IRQ                         ; We are at lower border (line 248)
	      LDA $D019
	      STA $D019
	      BMI RASIRQ
       	LDA $DC0D
	      CLI
	      JMP $EA31
RASIRQ
	      INC $D020
	      JSR PLAY
	      DEC $D020
	      JMP $FEBC

INIT
        LDX #$18                                              
        LDA #$00                                              
L00491  STA $D400,X         ; RESET SID REGISTERS             
        DEX                                                   
        BPL L00491                                            
        STA TICKLO
        STA TICKHI
        LDA #<SONG00
        STA $32
        LDA #>SONG00
        STA $33
        RTS                                                   

PLAY
L0001   LDY #0
        LDA ($32),Y
        CMP TICKHI
        BEQ L0004       ; TICKHI = ($32),Y
        BCC L0005       ; TICKHI > ($32),Y

L0002   INC TICKLO      ; (Ptr) > Tick
        BNE L0003
        INC TICKHI
L0003   RTS

L0004   LDY #1
        LDA ($32),Y
        CMP TICKLO
        BEQ L0007       ; TICKLO = ($32),Y
        BCC L0005       ; TICKLO > ($32),Y
        JMP L0002

L0005   LDA $32         ; (Ptr) < Tick
        CLC
        ADC #5
        STA $32
        BCC L0006
        INC $33
L0006   JMP L0001

L0007   LDY #2          ; (Ptr) = Tick
        LDA ($32),Y     ; A = OPCODE
        PHA
        AND #$F0
        CMP #$90        ; NOTEON?
        BNE L0008
        PLA             ; NOTEON
        AND #$0F
        TAY
        LDX CHANNEL,Y   ; X = 7 * CHANNEL
        LDY #3
        LDA ($32),Y
        STA $D400,X
        LDY #4
        LDA ($32),Y
        STA $D401,X
        LDA CURVOICE,X
        ORA #$01        ; GATE ON
        STA $D404,X
        JMP L0005

L0008   CMP #$80        ; NOTEOFF?
        BNE L0009
        PLA             ; NOTEOFF
        AND #$0F
        TAY
        LDX CHANNEL,Y   ; X = 7 * CHANNEL
        LDA CURVOICE,X
        AND #$FE        ; GATE OFF
        STA $D404,X
        JMP L0005

L0009   CMP #$E0        ; FREQ?
        BNE L0010
        PLA             ; FREQ
        AND #$0F
        TAY
        LDX CHANNEL,Y   ; X = 7 * CHANNEL
        LDY #3
        LDA ($32),Y
        STA $D400,X
        LDY #4
        LDA ($32),Y
        STA $D401,X
        JMP L0005

L0010   CMP #$C0        ; INSTR?
        BNE L0011
        PLA             ; INSTR
        AND #$0F
        TAY
        LDX CHANNEL,Y   ; X = 7 * CHANNEL
        LDA CURVOICE,X
        AND #$FE        ; GATE OFF
        STA $D404,X
        LDY #3
        LDA ($32),Y     ; A = INSTR NO.
        TAY
        LDA WAVEFRM,Y
        STA CURVOICE,X
        STA $D404,X
        LDA ATTDEC,Y
        STA $D405,X
        LDA SUSREL,Y
        STA $D406,X
        LDA PULSELO,Y
        STA $D402,X
        LDA PULSEHI,Y
        STA $D403,X
        JMP L0005

L0011   CMP #$B0        ; VOLUME?
        BNE L0012
        PLA             ; VOLUME
        LDY #3
        LDA ($32),Y
        STA $D418
        JMP L0005

L0012   PLA             ; MUST BE '$FF'
        LDA #$00
        STA TICKLO
        STA TICKHI
        LDA #<SONG00
        STA $32
        LDA #>SONG00
        STA $33
        JMP L0001

TiCKLO  .BYTE $00
TiCKHI  .BYTE $00

CHANNEL .BYTE $00, $07, $0E

CURVOICE
        .BYTE $00, $00, $00, $00, $00, $00, $00
        .BYTE $00, $00, $00, $00, $00, $00, $00
        .BYTE $00

;       6 INSTRUMENTS
WAVEFRM .BYTE $10, $20, $40, $10, $20, $40
ATTDEC  .BYTE $42, $42, $42, $00, $00, $00
SUSREL  .BYTE $E2, $7A, $20, $00, $00, $00
PULSELO .BYTE $00, $00, $00, $00, $00, $00
PULSEHI .BYTE $08, $08, $04, $00, $00, $00

SONG00
        .BYTE $00, $00, $C0, $00, $00
        .BYTE $00, $00, $B0, $0F, $00
        .BYTE $00, $00, $90, $31, $1C
        .BYTE $00, $00, $C1, $00, $00
        .BYTE $00, $00, $B0, $0F, $00
        .BYTE $00, $00, $91, $C2, $11
        .BYTE $00, $00, $C2, $00, $00
        .BYTE $00, $00, $92, $0C, $07
        .BYTE $00, $0B, $80, $00, $00
        .BYTE $00, $0D, $90, $61, $38
        .BYTE $00, $18, $80, $00, $00
        .BYTE $00, $19, $90, $3D, $2A
        .BYTE $00, $3C, $80, $00, $00
        .BYTE $00, $40, $90, $A1, $25
        .BYTE $00, $4B, $80, $00, $00
        .BYTE $00, $4C, $90, $3D, $2A
        .BYTE $00, $57, $80, $00, $00
        .BYTE $00, $59, $90, $A1, $25
        .BYTE $00, $64, $80, $00, $00
        .BYTE $00, $64, $81, $00, $00
        .BYTE $00, $64, $82, $00, $00
        .BYTE $00, $66, $90, $84, $23
        .BYTE $00, $66, $91, $D2, $0F
        .BYTE $00, $66, $92, $47, $06
        .BYTE $00, $71, $80, $00, $00
        .BYTE $00, $72, $90, $A1, $25
        .BYTE $00, $7E, $80, $00, $00
        .BYTE $00, $7F, $90, $3D, $2A
        .BYTE $00, $8A, $80, $00, $00
        .BYTE $00, $8C, $90, $31, $1C
        .BYTE $00, $BC, $80, $00, $00
        .BYTE $00, $BF, $90, $1D, $19
        .BYTE $00, $CA, $80, $00, $00
        .BYTE $00, $CA, $81, $00, $00
        .BYTE $00, $CA, $82, $00, $00
        .BYTE $00, $CB, $90, $31, $1C
        .BYTE $00, $CB, $91, $D1, $12
        .BYTE $00, $CB, $92, $E9, $07
        .BYTE $00, $D7, $80, $00, $00
        .BYTE $00, $D8, $90, $61, $38
        .BYTE $00, $E3, $80, $00, $00
        .BYTE $00, $E5, $90, $3D, $2A
        .BYTE $01, $08, $80, $00, $00
        .BYTE $01, $0B, $90, $A1, $25
        .BYTE $01, $16, $80, $00, $00
        .BYTE $01, $18, $90, $3D, $2A
        .BYTE $01, $23, $80, $00, $00
        .BYTE $01, $24, $90, $A1, $25
        .BYTE $01, $30, $80, $00, $00
        .BYTE $01, $30, $81, $00, $00
        .BYTE $01, $30, $82, $00, $00
        .BYTE $01, $31, $90, $84, $23
        .BYTE $01, $31, $91, $18, $0E
        .BYTE $01, $31, $92, $98, $05
        .BYTE $01, $3C, $80, $00, $00
        .BYTE $01, $3E, $90, $A1, $25
        .BYTE $01, $49, $80, $00, $00
        .BYTE $01, $4B, $90, $3D, $2A
        .BYTE $01, $87, $80, $00, $00
        .BYTE $01, $95, $81, $00, $00
        .BYTE $01, $95, $82, $00, $00
        .BYTE $01, $97, $90, $31, $1C
        .BYTE $01, $97, $91, $18, $0E
        .BYTE $01, $97, $C2, $01, $00
        .BYTE $01, $97, $92, $0C, $07
        .BYTE $01, $A0, $81, $00, $00
        .BYTE $01, $A2, $80, $00, $00
        .BYTE $01, $A4, $90, $61, $38
        .BYTE $01, $A4, $91, $18, $0E
        .BYTE $01, $AD, $81, $00, $00
        .BYTE $01, $AF, $80, $00, $00
        .BYTE $01, $AF, $82, $00, $00
        .BYTE $01, $B0, $90, $3D, $2A
        .BYTE $01, $B0, $91, $18, $0E
        .BYTE $01, $BA, $81, $00, $00
        .BYTE $01, $BD, $91, $18, $0E
        .BYTE $01, $BD, $92, $0C, $07
        .BYTE $01, $C6, $81, $00, $00
        .BYTE $01, $C8, $82, $00, $00
        .BYTE $01, $CA, $91, $18, $0E
        .BYTE $01, $CA, $92, $0C, $07
        .BYTE $01, $D3, $80, $00, $00
        .BYTE $01, $D3, $81, $00, $00
        .BYTE $01, $D6, $90, $A1, $25
        .BYTE $01, $D6, $91, $18, $0E
        .BYTE $01, $E0, $81, $00, $00
        .BYTE $01, $E2, $80, $00, $00
        .BYTE $01, $E2, $82, $00, $00
        .BYTE $01, $E3, $90, $3D, $2A
        .BYTE $01, $E3, $91, $18, $0E
        .BYTE $01, $ED, $81, $00, $00
        .BYTE $01, $EE, $80, $00, $00
        .BYTE $01, $F0, $90, $A1, $25
        .BYTE $01, $F0, $91, $18, $0E
        .BYTE $01, $F0, $92, $0C, $07
        .BYTE $01, $F9, $81, $00, $00
        .BYTE $01, $FB, $80, $00, $00
        .BYTE $01, $FB, $82, $00, $00
        .BYTE $01, $FD, $90, $84, $23
        .BYTE $01, $FD, $91, $18, $0E
        .BYTE $01, $FD, $92, $48, $05
        .BYTE $02, $06, $81, $00, $00
        .BYTE $02, $08, $80, $00, $00
        .BYTE $02, $09, $90, $A1, $25
        .BYTE $02, $09, $91, $18, $0E
        .BYTE $02, $13, $81, $00, $00
        .BYTE $02, $14, $80, $00, $00
        .BYTE $02, $14, $82, $00, $00
        .BYTE $02, $16, $90, $3D, $2A
        .BYTE $02, $16, $91, $18, $0E
        .BYTE $02, $1F, $81, $00, $00
        .BYTE $02, $21, $80, $00, $00
        .BYTE $02, $23, $90, $31, $1C
        .BYTE $02, $23, $91, $18, $0E
        .BYTE $02, $23, $92, $48, $05
        .BYTE $02, $2C, $81, $00, $00
        .BYTE $02, $2E, $82, $00, $00
        .BYTE $02, $2F, $91, $18, $0E
        .BYTE $02, $2F, $92, $48, $05
        .BYTE $02, $39, $81, $00, $00
        .BYTE $02, $3C, $91, $18, $0E
        .BYTE $02, $46, $81, $00, $00
        .BYTE $02, $47, $82, $00, $00
        .BYTE $02, $49, $91, $18, $0E
        .BYTE $02, $52, $80, $00, $00
        .BYTE $02, $52, $81, $00, $00
        .BYTE $02, $56, $90, $1D, $19
        .BYTE $02, $56, $91, $18, $0E
        .BYTE $02, $56, $92, $48, $05
        .BYTE $02, $5F, $81, $00, $00
        .BYTE $02, $61, $80, $00, $00
        .BYTE $02, $61, $82, $00, $00
        .BYTE $02, $62, $90, $31, $1C
        .BYTE $02, $62, $91, $18, $0E
        .BYTE $02, $62, $92, $F5, $03
        .BYTE $02, $6C, $81, $00, $00
        .BYTE $02, $6D, $80, $00, $00
        .BYTE $02, $6F, $90, $61, $38
        .BYTE $02, $6F, $91, $18, $0E
        .BYTE $02, $78, $81, $00, $00
        .BYTE $02, $7A, $80, $00, $00
        .BYTE $02, $7A, $82, $00, $00
        .BYTE $02, $7C, $90, $3D, $2A
        .BYTE $02, $7C, $91, $18, $0E
        .BYTE $02, $85, $81, $00, $00
        .BYTE $02, $88, $91, $18, $0E
        .BYTE $02, $88, $92, $F5, $03
        .BYTE $02, $92, $81, $00, $00
        .BYTE $02, $93, $82, $00, $00
        .BYTE $02, $95, $91, $18, $0E
        .BYTE $02, $95, $92, $F5, $03
        .BYTE $02, $9F, $80, $00, $00
        .BYTE $02, $9F, $81, $00, $00
        .BYTE $02, $A2, $90, $A1, $25
        .BYTE $02, $A2, $91, $18, $0E
        .BYTE $02, $AB, $81, $00, $00
        .BYTE $02, $AD, $80, $00, $00
        .BYTE $02, $AD, $82, $00, $00
        .BYTE $02, $AE, $90, $3D, $2A
        .BYTE $02, $AE, $91, $18, $0E
        .BYTE $02, $B8, $81, $00, $00
        .BYTE $02, $BA, $80, $00, $00
        .BYTE $02, $BB, $90, $A1, $25
        .BYTE $02, $BB, $91, $18, $0E
        .BYTE $02, $BB, $92, $F5, $03
        .BYTE $02, $C5, $81, $00, $00
        .BYTE $02, $C6, $80, $00, $00
        .BYTE $02, $C6, $82, $00, $00
        .BYTE $02, $C8, $90, $84, $23
        .BYTE $02, $C8, $91, $18, $0E
        .BYTE $02, $C8, $92, $5A, $02
        .BYTE $02, $D1, $81, $00, $00
        .BYTE $02, $D3, $80, $00, $00
        .BYTE $02, $D5, $90, $A1, $25
        .BYTE $02, $D5, $91, $18, $0E
        .BYTE $02, $DE, $81, $00, $00
        .BYTE $02, $E0, $80, $00, $00
        .BYTE $02, $E0, $82, $00, $00
        .BYTE $02, $E1, $90, $3D, $2A
        .BYTE $02, $E1, $91, $18, $0E
        .BYTE $02, $EB, $81, $00, $00
        .BYTE $02, $EE, $91, $18, $0E
        .BYTE $02, $EE, $92, $5A, $02
        .BYTE $02, $F8, $81, $00, $00
        .BYTE $02, $F9, $82, $00, $00
        .BYTE $02, $FB, $91, $18, $0E
        .BYTE $02, $FB, $92, $5A, $02
        .BYTE $03, $04, $81, $00, $00
        .BYTE $03, $07, $91, $18, $0E
        .BYTE $03, $11, $81, $00, $00
        .BYTE $03, $13, $82, $00, $00
        .BYTE $03, $14, $91, $18, $0E
        .BYTE $03, $1E, $80, $00, $00
        .BYTE $03, $1E, $81, $00, $00
        .BYTE $03, $21, $91, $18, $0E
        .BYTE $03, $2A, $81, $00, $00
        .BYTE $03, $2E, $C0, $01, $00
        .BYTE $03, $2E, $90, $84, $23
        .BYTE $03, $2E, $C1, $02, $00
        .BYTE $03, $2E, $91, $0C, $07
        .BYTE $03, $2E, $92, $0C, $07
        .BYTE $03, $39, $81, $00, $00
        .BYTE $03, $39, $82, $00, $00
        .BYTE $03, $3A, $91, $18, $0E
        .BYTE $03, $45, $81, $00, $00
        .BYTE $03, $47, $91, $8F, $0A
        .BYTE $03, $47, $92, $0C, $07
        .BYTE $03, $52, $82, $00, $00
        .BYTE $03, $60, $92, $0C, $07
        .BYTE $03, $6A, $81, $00, $00
        .BYTE $03, $6C, $82, $00, $00
        .BYTE $03, $6D, $91, $68, $09
        .BYTE $03, $78, $81, $00, $00
        .BYTE $03, $7A, $91, $8F, $0A
        .BYTE $03, $7A, $92, $0C, $07
        .BYTE $03, $85, $81, $00, $00
        .BYTE $03, $85, $82, $00, $00
        .BYTE $03, $87, $91, $68, $09
        .BYTE $03, $92, $80, $00, $00
        .BYTE $03, $92, $81, $00, $00
        .BYTE $03, $93, $90, $A4, $1F
        .BYTE $03, $93, $91, $E1, $08
        .BYTE $03, $93, $92, $48, $05
        .BYTE $03, $9E, $81, $00, $00
        .BYTE $03, $9E, $82, $00, $00
        .BYTE $03, $A0, $91, $68, $09
        .BYTE $03, $AB, $81, $00, $00
        .BYTE $03, $AD, $91, $8F, $0A
        .BYTE $03, $AD, $92, $48, $05
        .BYTE $03, $B8, $81, $00, $00
        .BYTE $03, $B8, $82, $00, $00
        .BYTE $03, $B9, $91, $0C, $07
        .BYTE $03, $C6, $92, $48, $05
        .BYTE $03, $D1, $82, $00, $00
        .BYTE $03, $E0, $92, $48, $05
        .BYTE $03, $EB, $82, $00, $00
        .BYTE $03, $EC, $81, $00, $00
        .BYTE $03, $F7, $80, $00, $00
        .BYTE $03, $F9, $90, $31, $1C
        .BYTE $03, $F9, $C1, $00, $00
        .BYTE $03, $F9, $91, $DA, $0B
        .BYTE $03, $F9, $92, $F5, $03
        .BYTE $04, $04, $81, $00, $00
        .BYTE $04, $04, $82, $00, $00
        .BYTE $04, $06, $91, $18, $0E
        .BYTE $04, $11, $81, $00, $00
        .BYTE $04, $12, $91, $1E, $15
        .BYTE $04, $12, $92, $F5, $03
        .BYTE $04, $1E, $82, $00, $00
        .BYTE $04, $2C, $92, $F5, $03
        .BYTE $04, $35, $81, $00, $00
        .BYTE $04, $37, $82, $00, $00
        .BYTE $04, $39, $91, $D1, $12
        .BYTE $04, $44, $81, $00, $00
        .BYTE $04, $45, $91, $1E, $15
        .BYTE $04, $45, $92, $F5, $03
        .BYTE $04, $50, $81, $00, $00
        .BYTE $04, $50, $82, $00, $00
        .BYTE $04, $52, $91, $D1, $12
        .BYTE $04, $5D, $81, $00, $00
        .BYTE $04, $5F, $91, $C2, $11
        .BYTE $04, $5F, $92, $5A, $02
        .BYTE $04, $6A, $81, $00, $00
        .BYTE $04, $6A, $82, $00, $00
        .BYTE $04, $6B, $91, $D1, $12
        .BYTE $04, $77, $81, $00, $00
        .BYTE $04, $78, $91, $1E, $15
        .BYTE $04, $78, $92, $5A, $02
        .BYTE $04, $83, $81, $00, $00
        .BYTE $04, $83, $82, $00, $00
        .BYTE $04, $85, $91, $60, $16
        .BYTE $04, $92, $92, $5A, $02
        .BYTE $04, $9D, $82, $00, $00
        .BYTE $04, $AB, $C2, $00, $00
        .BYTE $04, $AB, $92, $B4, $04
        .BYTE $04, $B6, $82, $00, $00
        .BYTE $04, $B8, $81, $00, $00
        .BYTE $04, $B8, $92, $71, $04
        .BYTE $04, $C3, $80, $00, $00
        .BYTE $04, $C3, $82, $00, $00
        .BYTE $04, $C4, $C0, $00, $00
        .BYTE $04, $C4, $90, $C2, $11
        .BYTE $04, $C4, $91, $4E, $0D
        .BYTE $04, $C4, $92, $86, $03
        .BYTE $04, $D0, $82, $00, $00
        .BYTE $04, $D1, $90, $D1, $12
        .BYTE $04, $D8, $90, $C2, $11
        .BYTE $04, $DE, $90, $D2, $0F
        .BYTE $04, $EB, $90, $4E, $0D
        .BYTE $04, $EB, $92, $86, $03
        .BYTE $04, $F6, $82, $00, $00
        .BYTE $04, $F7, $92, $86, $03
        .BYTE $05, $02, $82, $00, $00
        .BYTE $05, $1D, $80, $00, $00
        .BYTE $05, $1D, $92, $48, $05
        .BYTE $05, $29, $81, $00, $00
        .BYTE $05, $29, $82, $00, $00
        .BYTE $05, $2A, $90, $C2, $11
        .BYTE $05, $2A, $91, $8F, $0C
        .BYTE $05, $2A, $92, $47, $06
        .BYTE $05, $37, $90, $D1, $12
        .BYTE $05, $3D, $90, $C2, $11
        .BYTE $05, $44, $90, $D2, $0F
        .BYTE $05, $4F, $82, $00, $00
        .BYTE $05, $50, $90, $8F, $0C
        .BYTE $05, $50, $92, $47, $06
        .BYTE $05, $5B, $82, $00, $00
        .BYTE $05, $5D, $92, $47, $06
        .BYTE $05, $82, $82, $00, $00
        .BYTE $05, $83, $80, $00, $00
        .BYTE $05, $8E, $81, $00, $00
        .BYTE $05, $90, $90, $C2, $11
        .BYTE $05, $90, $91, $DA, $0B
        .BYTE $05, $9D, $90, $D1, $12
        .BYTE $05, $A3, $90, $C2, $11
        .BYTE $05, $A9, $90, $D2, $0F
        .BYTE $05, $B6, $90, $C2, $11
        .BYTE $05, $E9, $80, $00, $00
        .BYTE $05, $F4, $81, $00, $00
        .BYTE $05, $F6, $90, $C2, $11
        .BYTE $05, $F6, $91, $30, $0B
        .BYTE $06, $02, $90, $D1, $12
        .BYTE $06, $09, $90, $C2, $11
        .BYTE $06, $0F, $90, $D2, $0F
        .BYTE $06, $1C, $90, $D1, $12
        .BYTE $06, $4F, $80, $00, $00
        .BYTE $06, $5A, $81, $00, $00
        .BYTE $07, $40, $FF, $00, $00
